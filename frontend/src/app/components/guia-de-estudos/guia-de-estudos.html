<!-- Skeleton Loader -->
@if (isLoading()) {
    <div class="container">
      <div class="header-section text-center mb-6">
        <p-skeleton width="20rem" height="3rem" styleClass="mb-2 mx-auto"></p-skeleton>
        <p-skeleton width="30rem" height="1.5rem" styleClass="mx-auto"></p-skeleton>
      </div>
    
      <!-- Skeleton for Hero Bundle -->
      <div class="hero-bundle mb-8 border-round-3xl overflow-hidden shadow-4 bg-white">
        <div class="flex flex-column lg:flex-row">
          <div class="lg:w-6 w-full h-20rem lg:h-auto">
            <p-skeleton width="100%" height="100%"></p-skeleton>
          </div>
          <div class="lg:w-6 w-full p-6 flex flex-column justify-content-center">
            <p-skeleton width="8rem" height="1.5rem" styleClass="mb-3"></p-skeleton>
            <p-skeleton width="100%" height="3rem" styleClass="mb-3"></p-skeleton>
            <p-skeleton width="90%" height="1rem" styleClass="mb-1"></p-skeleton>
            <p-skeleton width="80%" height="1rem" styleClass="mb-5"></p-skeleton>
            <div class="flex flex-wrap gap-2 mb-5">
              <p-skeleton width="5rem" height="2rem"></p-skeleton>
              <p-skeleton width="5rem" height="2rem"></p-skeleton>
              <p-skeleton width="5rem" height="2rem"></p-skeleton>
            </div>
            <div class="flex gap-3">
              <p-skeleton width="100%" height="3rem"></p-skeleton>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Skeleton for Grid -->
      <div class="grid">
        @for(item of [1,2,3]; track item) {
        <div class="col-12 md:col-6 lg:col-4 p-3">
          <div class="border-round-2xl overflow-hidden shadow-2 bg-white h-full">
            <p-skeleton width="100%" height="14rem"></p-skeleton>
            <div class="p-4">
              <p-skeleton width="6rem" height="1rem" styleClass="mb-2"></p-skeleton>
              <p-skeleton width="100%" height="1.5rem" styleClass="mb-3"></p-skeleton>
              <div class="flex gap-2 mb-4">
                <p-skeleton width="3rem" height="2rem"></p-skeleton>
                <p-skeleton width="3rem" height="2rem"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="2.5rem"></p-skeleton>
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    } @else {
    <div class="container fade-in">
      <div class="header-section text-center mb-7 mt-4">
        <h1 class="text-5xl font-bold mb-3 text-900 bg-clip-text text-transparent bg-gradient-to-r from-primary-700 to-primary-500">
            Materiais de Estudo
        </h1>
        <p class="text-700 text-xl max-w-30rem mx-auto">
            Baixe slides, mapas e guias exclusivos para enriquecer sua preparação semanal.
        </p>
      </div>
    
      <!-- Latest Bundle (Hero) -->
      @if (latestBundle) {
      <div class="hero-bundle mb-8 border-round-3xl overflow-hidden shadow-4 bg-white surface-card relative">
        <div class="flex flex-column lg:flex-row h-full">
          <!-- Image Section -->
          <div class="lg:w-7 w-full relative h-25rem lg:h-auto overflow-hidden">
            <div class="absolute inset-0 bg-gray-900 z-1 opacity-20"></div>
            <img
              [src]="getThumbnail(latestBundle.youtube_link)"
              class="w-full h-full object-cover transition-transform duration-700 hover:scale-105"
              alt="Capa da Lição"
              style="object-position: center;"
            />
            
            <!-- Badges overlay -->
            <div class="absolute top-0 left-0 m-4 flex gap-2 z-2">
              <p-tag value="Destaque da Semana" severity="warn" [rounded]="true" icon="pi pi-star-fill"></p-tag>
            </div>
             <div class="absolute bottom-0 right-0 m-4 z-2">
                 <p-tag [value]="latestBundle.trimester" severity="info" [rounded]="true" styleClass="text-sm shadow-2"></p-tag>
             </div>
          </div>
    
          <!-- Content Section -->
          <div class="lg:w-5 w-full p-5 lg:p-7 flex flex-column justify-content-center bg-white">
            <div class="mb-3 flex align-items-center gap-2">
                 <span class="text-primary font-bold uppercase tracking-wider text-sm border-1 border-primary px-2 py-1 border-round">
                    Lição {{ latestBundle.lesson_number }}
                 </span>
            </div>
    
            <h2 class="text-4xl font-bold mt-0 mb-3 text-900 line-height-2">
              {{ latestBundle.title }}
            </h2>
    
            <p class="text-600 mb-5 text-lg line-height-3">
              Prepare-se com profundidade. Este kit inclui tudo o que você precisa para uma aula inesquecível.
            </p>
    
            <!-- Quick Downloads -->
            <div class="mb-5">
                <p class="text-sm font-semibold text-500 mb-2 uppercase tracking-wide">Incluso no Kit:</p>
                <div class="flex flex-wrap gap-2">
                  <a *ngIf="latestBundle.file_guide_url" [href]="latestBundle.file_guide_url" target="_blank" class="no-underline">
                    <p-chip label="Guia em PDF" icon="pi pi-file-pdf" styleClass="cursor-pointer bg-gray-100 hover:bg-gray-200 transition-colors"></p-chip>
                  </a>
                  <a *ngIf="latestBundle.file_slides_url" [href]="latestBundle.file_slides_url" target="_blank" class="no-underline">
                    <p-chip label="Slides PowerPoint" icon="pi pi-desktop" styleClass="cursor-pointer bg-gray-100 hover:bg-gray-200 transition-colors"></p-chip>
                  </a>
                  <a *ngIf="latestBundle.file_map_url" [href]="latestBundle.file_map_url" target="_blank" class="no-underline">
                    <p-chip label="Mapas" icon="pi pi-map" styleClass="cursor-pointer bg-gray-100 hover:bg-gray-200 transition-colors"></p-chip>
                  </a>
                </div>
            </div>
    
            <!-- Main Actions -->
            <div class="flex flex-column gap-3">
              <a [href]="'/api/bundles/' + latestBundle.id + '/download'" class="no-underline w-full">
                <button pButton pRipple label="Baixar Kit Completo (ZIP)" icon="pi pi-download" class="w-full p-button-lg btn-primary-gradient border-round-xl"></button>
              </a>
              
              <div class="flex gap-2">
                <a *ngIf="latestBundle.article_link" [href]="latestBundle.article_link" target="_blank" class="flex-1 no-underline">
                  <button pButton pRipple label="Ler Artigo" icon="pi pi-book" class="w-full p-button-outlined p-button-secondary border-round-xl"></button>
                </a>
                <a *ngIf="latestBundle.youtube_link" [href]="latestBundle.youtube_link" target="_blank" class="flex-1 no-underline">
                  <button pButton pRipple label="Assistir Vídeo" icon="pi pi-youtube" class="w-full p-button-outlined p-button-secondary border-round-xl"></button>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      }
    
      <!-- Divider -->
      <div class="flex align-items-center mb-6">
        <div class="flex-1 h-1px bg-200"></div>
        <h3 class="mx-4 text-2xl font-bold text-700 m-0">Arquivo de Materiais</h3>
        <div class="flex-1 h-1px bg-200"></div>
      </div>
    
      <!-- Regular Bundle Grid -->
      <div class="grid">
        @for (bundle of visibleBundles; track bundle.id) {
        <div class="col-12 md:col-6 lg:col-4 p-3">
          <div class="bundle-card h-full flex flex-column bg-white border-round-2xl overflow-hidden shadow-2 relative border-1 border-transparent hover:border-primary-100">
            
            <!-- Card Image -->
            <div class="relative h-15rem overflow-hidden bg-gray-100">
              <img
                [src]="getThumbnail(bundle.youtube_link)"
                class="w-full h-full object-cover transition-transform duration-500 hover:scale-105"
                alt="Thumbnail"
                loading="lazy"
              />
              <div class="absolute top-0 right-0 m-2">
                 <p-tag [value]="'Lição ' + bundle.lesson_number" severity="contrast" [rounded]="true"></p-tag>
              </div>
            </div>
    
            <!-- Card Body -->
            <div class="p-4 flex flex-column flex-grow-1">
              <div class="mb-2">
                 <span class="text-xs font-semibold text-500 bg-gray-100 px-2 py-1 border-round">{{bundle.trimester}}</span>
              </div>
              
              <h4 class="text-xl font-bold mb-3 mt-1 text-900 line-clamp-2 min-h-4rem">
                {{ bundle.title }}
              </h4>
    
              <!-- Available Files Indicators -->
              <div class="flex gap-2 mb-4">
                 @if(bundle.file_guide_url) { <i class="pi pi-file-pdf text-xl text-primary-500" pTooltip="Guia PDF" tooltipPosition="top"></i> }
                 @if(bundle.file_slides_url) { <i class="pi pi-desktop text-xl text-primary-500" pTooltip="Slides" tooltipPosition="top"></i> }
                 @if(bundle.file_map_url) { <i class="pi pi-map text-xl text-primary-500" pTooltip="Mapas" tooltipPosition="top"></i> }
              </div>
    
              <!-- Actions -->
              <div class="mt-auto grid gap-2">
                <a [href]="'/api/bundles/' + bundle.id + '/download'" class="col-12 no-underline">
                  <button pButton label="Baixar Materiais" icon="pi pi-download" class="w-full p-button-outlined p-button-primary border-round-lg"></button>
                </a>
                
                <div class="col-6 pr-1">
                     <a *ngIf="bundle.article_link" [href]="bundle.article_link" target="_blank" class="no-underline w-full">
                        <button pButton icon="pi pi-book" class="w-full p-button-text p-button-secondary p-0" pTooltip="Ler Artigo"></button>
                     </a>
                </div>
                <div class="col-6 pl-1">
                     <a *ngIf="bundle.youtube_link" [href]="bundle.youtube_link" target="_blank" class="no-underline w-full">
                         <button pButton icon="pi pi-youtube" class="w-full p-button-text p-button-secondary p-0" pTooltip="Ver Vídeo"></button>
                     </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        }
      </div>
    
      <!-- Load More Button -->
      @if (visibleBundles.length < allPreviousBundles.length) {
      <div class="text-center mt-7 mb-5">
        <button
          pButton
          label="Carregar Mais Lições"
          icon="pi pi-plus"
          (click)="loadMore()"
          class="p-button-outlined p-button-rounded px-6 py-3 border-400 text-700 hover:text-primary hover:border-primary transition-all font-bold shadow-1"
        ></button>
      </div>
      }
    </div>
    }
    
